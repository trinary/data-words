<template id="sparkline">
  <style>
    :host {
      display: inline;
    }
    svg {
      width: 80px;
      height: 20px;
    }
    .line {
      fill: none;
      stroke: #333;
    }
  </style>
  <svg><path class="line"></path></svg>
</template>

<script>
  var scale = function(domain, range) {
    return function(v) { 
      var s = ((range[1] - range[0]) / (domain[1] - domain[0]))
      return (v * s) + (range[0] - (s * domain[0]));
    }
  }, thisDoc, pathString, sparkProto, Spark;

  for (doc in this.HTMLImports.importer.documents) {
    if (doc.match(/\/elements\/sparkline\.html$/)) {
      thisDoc = this.HTMLImports.importer.documents[doc];
    }
  }

  pathString = function(values, width, height) {
    var space = width / (values.length - 1),
        y = scale([Math.min.apply({},values), Math.max.apply({},values)], [height,0]);
    return "M0," + height + " "  + values.map(function(d,i) { return 'L' + (space*i) + ',' + y(d)}).join(' ');
  }
  sparkProto = Object.create(HTMLElement.prototype, {
    createdCallback: {
      value: function() {
        var t = thisDoc.querySelector('#sparkline').content,
          path = "", root = this.createShadowRoot(), line,
          data = this.getAttribute("data").split(/\s+/).map(function(d) {
            return parseFloat(d);
          });

        line = t.querySelector(".line");
        line.setAttribute("d", pathString(data, 80, 20));
        root.appendChild(t);
      }
    }
  });

  Object.defineProperty(sparkProto, "data", {value : "",
                                              writable : true,
                                              enumerable : true,
                                              configurable : true});

  Spark = document.register('dw-sparkline',{
    prototype: sparkProto
  });
</script>
